---
import { PLACES, listAreas } from "../data/places";

const primaryLabel = (specialisms: string[]) => {
  const s = new Set(specialisms);
  const priority = [
    "Psychiatry",
    "Psychology",
    "Psychotherapy",
    "Counselling",
    "CBT",
    "EMDR",
    "Mindfulness",
    "Yoga",
    "Pilates",
    "Massage",
    "Spa",
    "Wellbeing",
  ];
  for (const p of priority) if (s.has(p)) return p;
  return specialisms[0] ?? "Wellbeing";
};

const url = new URL(Astro.request.url);
const q = (url.searchParams.get("q") ?? "").trim().toLowerCase();
const category = (url.searchParams.get("category") ?? "").trim();

const places = PLACES.filter((p) => {
  if (category && primaryLabel(p.specialisms).toLowerCase() !== category.toLowerCase()) return false;
  if (!q) return true;
  const hay = [
    p.name,
    p.area,
    p.locationNote,
    p.specialisms.join(" "),
    p.sessionFormat,
    p.blurb,
  ]
    .join(" ")
    .toLowerCase();
  return hay.includes(q);
});

const areas = listAreas();
const categories = Array.from(new Set(PLACES.map((p) => primaryLabel(p.specialisms)))).sort();

// Prefer more complete listings.
const primaryScore = (p: any) => (p.website ? 10 : 0) + (/\b[A-Z]{1,2}\d/i.test(p.locationNote) ? 3 : 0);
const placesSorted = [...places].sort((a, b) => primaryScore(b) - primaryScore(a));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Therapy & Wellbeing in London — Directory</title>
    <meta
      name="description"
      content="A directory of therapy and wellbeing providers in London. Verify services, pricing, and availability directly with each provider."
    />
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial;
        margin: 0;
        color: #111;
      }
      a { color: inherit; }
      .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
      .card { border: 1px solid #eee; padding: 14px; margin-bottom: 10px; }
      .pill {
        border: 1px solid #ddd;
        padding: 6px 10px;
        border-radius: 999px;
        display: inline-block;
        text-decoration: none;
      }
      .tag {
        display: inline-block;
        border: 1px solid #eee;
        background: #fafafa;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        color: #444;
        white-space: nowrap;
      }
      .muted { color:#555; }
    </style>
  </head>
  <body>
    <main class="wrap">
      <header>
        <h1 style="font-size: 32px; margin: 0 0 8px;">Therapy & Wellbeing (London)</h1>
        <p class="muted" style="margin:0 0 16px;">
          Directory MVP. Please verify services offered, pricing, and availability directly with each provider.
        </p>
      </header>

      <section style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px;">
        <form style="display:flex; gap:12px; flex-wrap:wrap;">
          <input
            name="q"
            value={q}
            placeholder="Search (area, specialism, online…)"
            style="padding:10px; min-width:320px;"
          />

          <select name="category" style="padding:10px;">
            <option value="" selected={!category}>All categories</option>
            {categories.map((c) => (
              <option value={c} selected={category.toLowerCase() === c.toLowerCase()}>
                {c}
              </option>
            ))}
          </select>

          <button type="submit" style="padding:10px 14px; cursor:pointer;">Search</button>
        </form>

        <a href="/london/therapy-and-wellbeing" style="margin-left:auto; text-decoration:underline;">Browse all →</a>
      </section>

      <section style="margin-bottom:24px;">
        <h2 style="font-size:20px; margin:0 0 8px;">Areas</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          {areas.map((a) => (
            <a class="pill" href={`/london/therapy-and-wellbeing?area=${encodeURIComponent(a)}`}>{a}</a>
          ))}
        </div>
      </section>

      <section>
        <h2 style="font-size:20px; margin:0 0 8px;">Listings ({places.length})</h2>
        <ul style="list-style:none; padding:0; margin:0;">
          {placesSorted.map((p) => (
            <li class="card">
              <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
                <div>
                  <a href={`/london/therapy-and-wellbeing/${p.slug}`}><strong>{p.name}</strong></a>
                  <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <span class="tag">{primaryLabel(p.specialisms)}</span>
                    <span class="muted">{p.specialisms.slice(0, 3).join(", ")}</span>
                  </div>
                </div>
                <span class="muted">{p.area}</span>
              </div>
            </li>
          ))}
        </ul>
      </section>

      <footer style="margin-top:24px;" class="muted">
        <p style="margin:0; font-size:14px;">
          This directory is informational and not medical advice.
          If you are in crisis, contact emergency services.
        </p>
      </footer>
    </main>
  </body>
</html>
